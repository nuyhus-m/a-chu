<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A-chu 채팅방 목록</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      position: relative;
    }

    .header {
      background-color: #4CAF50;
      color: white;
      padding: 20px;
      text-align: center;
    }

    .chat-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .chat-item {
      display: flex;
      padding: 15px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .chat-item:hover {
      background-color: #f9f9f9;
    }

    .profile-image {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin-right: 15px;
      object-fit: cover;
    }

    .chat-details {
      flex: 1;
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .chat-partner {
      font-weight: bold;
      font-size: 16px;
    }

    .chat-timestamp {
      color: #888;
      font-size: 12px;
    }

    .chat-message {
      color: #555;
      margin-bottom: 5px;
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .chat-goods {
      font-size: 13px;
      color: #888;
    }

    .badge {
      background-color: #FF5722;
      color: white;
      border-radius: 50%;
      min-width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-left: 8px;
      padding: 0 5px;
    }

    .unread-badge {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #FF5722;
      color: white;
      padding: 10px 15px;
      border-radius: 20px;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>채팅방 목록</h1>
    </div>

    <ul class="chat-list" id="chat-list">
      <!-- 채팅방 목록이 이곳에 렌더링됩니다 -->
    </ul>
  </div>

  <div class="unread-badge" id="unread-badge">읽지 않은 메시지: 0</div>

  <script>
    // 상수 및 전역 변수
    const BASE_URL = 'http://localhost:8080';
    const CHAT_ROOMS_URL = `${BASE_URL}/chat/rooms`;
    const UNREAD_COUNT_URL = `${BASE_URL}/chat/unread-count`;
    const WS_ENDPOINT = `${BASE_URL}/chat-ws`;

    let stompClient = null;
    let userId = 0;
    let accessToken = localStorage.getItem('accessToken') || '';
    let chatRooms = [];
    let totalUnreadCount = 0;

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', () => {
      // JWT 토큰에서 사용자 ID 추출
      try {
        if (accessToken) {
          const payload = JSON.parse(atob(accessToken.split('.')[1]));
          userId = payload.userId || 0;

          // 채팅방 목록 로드
          fetchChatRooms();

          // 안 읽은 메시지 수 로드
          fetchUnreadCount();

          // WebSocket 연결
          connectWebSocket();
        } else {
          alert('로그인이 필요합니다.');
          window.location.href = 'index.html';
        }
      } catch (e) {
        console.error('토큰 파싱 오류:', e);
        alert('세션이 만료되었습니다. 다시 로그인해주세요.');
        window.location.href = 'index.html';
      }
    });

    // 채팅방 목록 조회
    async function fetchChatRooms() {
      try {
        const response = await fetch(CHAT_ROOMS_URL, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${accessToken}`
          }
        });

        if (!response.ok) {
          throw new Error('채팅방 목록 조회 실패');
        }

        const data = await response.json();

        if (data.result === 'SUCCESS') {
          chatRooms = data.data;
          renderChatRooms();
        } else {
          throw new Error('채팅방 목록 조회 실패: ' + data.result);
        }
      } catch (error) {
        console.error('채팅방 목록 조회 오류:', error);
        alert('채팅방 목록을 불러오는데 실패했습니다.');
      }
    }

    // 안 읽은 메시지 수 조회
    async function fetchUnreadCount() {
      try {
        const response = await fetch(UNREAD_COUNT_URL, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${accessToken}`
          }
        });

        if (!response.ok) {
          throw new Error('안 읽은 메시지 수 조회 실패');
        }

        const data = await response.json();

        if (data.result === 'SUCCESS') {
          totalUnreadCount = data.data.unreadMessageCount;
          updateUnreadBadge();
        } else {
          throw new Error('안 읽은 메시지 수 조회 실패: ' + data.result);
        }
      } catch (error) {
        console.error('안 읽은 메시지 수 조회 오류:', error);
      }
    }

    // WebSocket 연결
    function connectWebSocket() {
      const socket = new SockJS(WS_ENDPOINT);
      stompClient = Stomp.over(socket);

      stompClient.connect(
        { 'Authorization': `Bearer ${accessToken}` },
        (frame) => {
          console.log('WebSocket 연결 성공:', frame);

          // 업데이트된 채팅방 정보 구독
          stompClient.subscribe(`/read/chat/users/${userId}/rooms/update`, (message) => {
            const updatedRoom = JSON.parse(message.body);
            console.log('채팅방 업데이트:', updatedRoom);
            updateChatRoom(updatedRoom.chatRoom);
          });

          // 새 메시지 도착 알림 구독
          stompClient.subscribe(`/read/chat/users/${userId}/message-arrived`, (message) => {
            console.log('새 메시지 도착 알림:', message.body);
            if (message.body === "NEW_MESSAGE_ARRIVED") {
              totalUnreadCount++;
              updateUnreadBadge();
            }
          });
        },
        (error) => {
          console.error('WebSocket 연결 오류:', error);
        }
      );
    }

    // 채팅방 목록 렌더링
    function renderChatRooms() {
      const chatListElement = document.getElementById('chat-list');
      chatListElement.innerHTML = '';

      chatRooms.forEach(room => {
        chatListElement.appendChild(createChatRoomElement(room));
      });
    }

    // 채팅방 요소 생성
    function createChatRoomElement(room) {
      const li = document.createElement('li');
      li.className = 'chat-item';
      li.dataset.roomId = room.id;

      // 채팅방 클릭 이벤트 - 채팅방 페이지로 이동
      li.addEventListener('click', () => {
        // 필요한 데이터를 localStorage에 저장하여 채팅방 페이지로 전달
        localStorage.setItem('currentChatRoom', JSON.stringify({
          roomId: room.id,
          partnerId: room.partner.id,
          partnerNickname: room.partner.nickname,
          partnerProfileImageUrl: room.partner.profileImageUrl,
          goodsId: room.goods.id,
          goodsTitle: room.goods.title,
          goodsThumbnailImageUrl: room.goods.thumbnailImageUrl,
          lastReadMessageId: room.lastMessage ? room.lastMessage.id : 0
        }));

        window.location.href = `chat-room.html?roomId=${room.id}`;
      });

      const lastMessage = room.lastMessage || {};
      const timestamp = lastMessage.timestamp ? new Date(lastMessage.timestamp) : null;
      const formattedTime = timestamp ? formatTime(timestamp) : '';

      li.innerHTML = `
        <img src="${room.partner.profileImageUrl || 'https://via.placeholder.com/50'}" alt="프로필" class="profile-image">
        <div class="chat-details">
          <div class="chat-header">
            <span class="chat-partner">${room.partner.nickname}</span>
            <span class="chat-timestamp">${formattedTime}</span>
          </div>
          <div class="chat-message">
            ${lastMessage.content || ''}
            ${room.unreadCount > 0 ? `<span class="badge">${room.unreadCount}</span>` : ''}
          </div>
          <div class="chat-goods">
            상품: ${room.goods.title}
          </div>
        </div>
      `;

      return li;
    }

    // 채팅방 업데이트
    function updateChatRoom(updatedRoom) {
      // 기존 채팅방 목록에서 해당 채팅방 제거
      chatRooms = chatRooms.filter(room => room.id !== updatedRoom.id);

      // 업데이트된 채팅방을 목록 맨 앞에 추가
      chatRooms.unshift(updatedRoom);

      // 채팅방 목록 다시 렌더링
      renderChatRooms();
    }

    // 안 읽은 메시지 배지 업데이트
    function updateUnreadBadge() {
      const badge = document.getElementById('unread-badge');

      if (totalUnreadCount > 0) {
        badge.textContent = `읽지 않은 메시지: ${totalUnreadCount}`;
        badge.style.display = 'block';
      } else {
        badge.style.display = 'none';
      }
    }

    // 시간 포맷팅 함수
    function formatTime(date) {
      const now = new Date();
      const yesterday = new Date(now);
      yesterday.setDate(yesterday.getDate() - 1);

      const isToday = date.toDateString() === now.toDateString();
      const isYesterday = date.toDateString() === yesterday.toDateString();

      if (isToday) {
        return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
      } else if (isYesterday) {
        return '어제';
      } else {
        return date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
      }
    }
  </script>
</body>

</html>